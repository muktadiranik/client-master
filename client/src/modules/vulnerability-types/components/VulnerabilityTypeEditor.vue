<template>
  <div class="section-vulnerability-type">
    <div class="u-position-relative">
      <div class="c-dropdown c-dropdown--select u-width-full" v-click-outside="hideDropdownMenu">
        <div
          class="c-dropdown__toggle o-btn o-btn--rounded o-btn--select"
          tabindex="0"
          :class="[{ 'is-open': expanded }]"
          @click="toggleDropdownMenu"
        >
          <span>{{ selectedVuln.name || 'Vulnerability Type' }}</span>
        </div>
        <ul class="c-dropdown__menu" :class="{ 'is-visible': expanded }">
          <li v-for="(vulnType, index) in vulnerabilityTypes" :key="`vulnType-${index}`" @click="selectVuln(vulnType)">
            {{ vulnType.name }}
          </li>
        </ul>
      </div>
    </div>
  </div>
</template>

<script>
import { CommonMixin } from '@/mixins/common'
import { clickOutside } from '@/directives/click-outside'

export default {
  name: 'VulnerabilityTypeEditor',
  components: {},
  directives: { clickOutside },
  mixins: [CommonMixin],
  props: {
    readOnly: {
      type: Boolean,
      default: false,
      required: false,
    },
    inputPlaceholder: {
      type: String,
      default: 'Search vulnerability type...',
      required: false,
    },
    reportVulnerabilityTypes: {
      type: Array,
      default: () => [],
      required: false,
    }
  },
  data() {
    return {
      searchResults: [],
      showVulnerabilitySearchResults: false,
      searchTerms: '',
      showVulnerabilitySearch: false,
      expanded: false,
      selectedVuln: '',
    }
  },
  computed: {
    filteredSearchResults() {
      if (!this.reportVulnerabilityTypes || !this.reportVulnerabilityTypes.length) {
        return this.searchResults
      }

      const vulnerabilityTypeUuids = this.reportVulnerabilityTypes.map((x) => x.uuid)

      return this.searchResults.filter((x) => !vulnerabilityTypeUuids.includes(x.uuid))
    },
  },
  methods: {
    onVulnerabilityTypeTextInput(val) {
      this.searchTerms = val

      if (!val) {
        this.searchResults = []
        this.showVulnerabilitySearchResults = false
        return
      }

      this.searchResults = this.vulnerabilityTypes.filter((x) => x.name.toLowerCase().includes(val.toLowerCase()))

      if (this.searchResults && this.searchResults.length > 0) {
        this.showVulnerabilitySearchResults = true
      }
    },
    clickOutsideSearchResults(e) {
      const targetId = e && e.target && e.target.id ? e.target.id : ''
      if (targetId && targetId === 'vulnerability-type-search-terms-input') {
        return
      }

      this.showVulnerabilitySearchResults = false
    },
    toggleVulnerabilitySearch() {
      this.showVulnerabilitySearch = !this.showVulnerabilitySearch
    },
    searchTermsInputClick() {
      if (this.searchTerms) {
        this.showVulnerabilitySearchResults = true
      }
    },
    clearSearch() {
      this.searchTerms = ''
      this.searchResults = []
    },
    toggleDropdownMenu(event) {
      this.expanded = !this.expanded
    },
    hideDropdownMenu() {
      this.expanded = false
    },
    selectVuln(vuln) {
      this.selectedVuln = vuln
      this.expanded = false
      this.$emit('on-add-vulnerability-type', vuln)
    },
  },
  async mounted() {
    await this.actionLoadVulnerabilityTypes()
    // for setting vulnerability type if editing
    if (this.reportVulnerabilityTypes[0]) {
      this.selectedVuln = this.reportVulnerabilityTypes[0]
    }
  },
}
</script>
